# Query нагрузка

Выполняет пользовательскую нагрузку, состоящую из нескольких этапов.
Пользователь указывает путь к каталогу, называемому `suite`, который содержит подкаталоги для каждого этапа. Этот путь указывается с помощью параметра `--suite-path` в каждой команде.

Пример каталога `suite` на [GitHub](https://github.com/ydb-platform/ydb/tree/main/ydb/tests/functional/tpc/data/e1).

Набор может содержать до четырех этапов:

1. init
    Инициализация таблиц и их конфигурация, обычно включающая DDL-запросы из файлов с расширениями `sql` и `yql`. Эти запросы также можно напрямую указать из командной строки с помощью параметра `--query` команды `init`.

2. import
    Заполнение таблиц данными. Каталог `import` должен содержать подпапки, названные по имени каждой таблицы, с файлами в поддерживаемых форматах данных, такими как `csv`, `tsv`, `csv.gz`, `tsv.gz` или `parquet`.

3. run
    Выполнение нагрузочного тестирования с использованием запросов из файлов в каталоге `run` или напрямую из командной строки через параметр `--query`.

    Для генерации запросов будут использоваться файлы с расширениями `sql` и `yql`. Для каждого из них может быть задан канонический результат с помощью файла с тем же именем и дополнительным расширением `.result`. Это файлы CSV с заголовками и некоторым дополнительным синтаксисом:
        - Если запрос имеет более одного набора результатов, файл результатов должен содержать соответсвующее количество наборов данных, разделенных пустыми строками.
        - Последняя строка может быть задана как `...`, что означает, что результат запроса может иметь больше строк, но будут проверены только первые.
        - По умолчанию числа с плавающей точкой сравниваются с относительной точностью `1e-3` процента, но вы можете указать любую абсолютную или относительную точность, например: `1.5+-0.01`, `2.4e+10+-1%`.

    Канонический результат не будет использоваться, если не установлен флаг `--check-canonical`.

4. clean
    Очистка путем удаления таблиц, используемых для нагрузочного тестирования. Для этого шага требуется только путь в базе данных.

## Общие параметры команд

Все команды поддерживают общий параметр `--path`, который задает путь к таблице в базе данных:

```bash
{{ ydb-cli }} workload query --path user ...
```

### Доступные параметры { #common_options }

| Имя                | Описание       | Значение по умолчанию |
|--------------------|----------------|-----------------------|
|  `--path` или `-p` | Путь к таблице | Корень базы данных    |

## Инициализация нагрузочного теста { #init }

Перед запуском теста создайте таблицу:

```bash
{{ ydb-cli }} workload query --path user init --suite-path ~/user-suite
```

Посмотрите описание команды для запуска нагрузки:

```bash
{{ ydb-cli }} workload query init --help
```

### Доступные параметры { #init_options }

| Имя                                 | Описание                                                                         | Значение по умолчанию |
|-------------------------------------|----------------------------------------------------------------------------------|-----------------------|
| `--suite-path <путь>`               | Путь к `suite`-директории. См. [описание](./workload-query.md).                  |                       |
| `--query <запрос>` or `-q <запрос>` | DDL-запрос для выполнения. Может быть использован несколько раз.                 |                       |
| `--clear`                           | Если по указанному пути таблица уже была создана, она будет удалена              |                       |
| `--dry-run`                         | Не выполнять инициализационные запросы, а только распечатать их                  |                       |

## Загрузка данных в таблицу { #load }

Загрузите данные в таблицы:

```bash
{{ ydb-cli }} workload query --path user import --suite-path ~/user-suite
```

Посмотрите описание команды для загрузки данных:

```bash
{{ ydb-cli }} workload query import --help
```

В качестве исходных файлов можно использовать как распакованные и запакованные csv, tsv и psv файлы, так и файлы parquet.

### Доступные параметры { #load_files_options }

| Имя                   | Описание                                                                                                                                       | Значение по умолчанию |
|-----------------------|------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------|
| `--suite-path <путь>` | Путь к `suite`-директории. См. [описание](./workload-query.md).                                                                                |                       |
| `--state <путь>`      | Путь к файлу состояния загрузки. Если загрузка была прервана по какой-то причине, при новом запуске загрузка будет продолжена с того же места. |                       |
| `--clear-state`       | Актуально, если задан параметр `--state`. Очистить файл состояния и начать загрузку сначала.                                                   |                       |
| `--dry-run`           | Не выполнять загрузку данных в базу данных                                                                                                     |                       |

{% include [load_options](./_includes/workload/load_options.md) %}

## Запуск нагрузочного теста { #run }

Запустите нагрузку:

```bash
{{ ydb-cli }} workload query --path user run --suite-path ~/user-suite
```

В течение теста на экран выводится статистика по нагрузке для каждого запроса.

Посмотрите описание команды для запуска нагрузки:

```bash
{{ ydb-cli }} workload query run --help
```

{% include [run_options](./_includes/workload/run_options.md) %}

### Опции, специфичные для Query { #run_query_options }

| Имя                                 | Описание                                                        | Значение по умолчанию |
|-------------------------------------|-----------------------------------------------------------------|-----------------------|
| `--suite-path <путь>`               | Путь к `suite`-директории. См. [описание](./workload-query.md). |                       |
| `--query <запрос>` or `-q <запрос>` | Запрос для выполнения. Может быть использован несколько раз.    |                       |

## Очистка данных теста { #cleanup }

Запустите очистку:

```bash
{{ ydb-cli }} workload query --path user clean
```

Команда не имеет параметров.
